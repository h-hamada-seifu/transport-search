# 進路指導訪問 所要時間検索アプリ 設計書

## 1. プロジェクト概要

### 1.1 目的
教員が進路指導で学校訪問する際の、自宅最寄り駅から訪問先学校までの所要時間・距離を簡単に検索できるWebアプリケーションを開発する。

### 1.2 基本要件
- 出発駅と訪問先学校名を入力
- 電車での所要時間と距離を表示
- 運賃は表示しない（今回のスコープ外）
- データベースは使用しない（テスト版）
- Vercelにデプロイ

---

## 2. NAVITIME RapidAPI 調査結果

### 2.1 利用可能なAPIサービス

RapidAPIでは以下の3つのサービスを**それぞれ別契約**で利用する必要がある：

| サービス名 | 用途 | BASIC（無料）| エンドポイント |
|-----------|------|-------------|---------------|
| NAVITIME Transport | 駅検索 | 500回/月 | `navitime-transport.p.rapidapi.com` |
| NAVITIME Spot | スポット（学校）検索 | 500回/月 | `navitime-spot.p.rapidapi.com` |
| NAVITIME Route(totalnavi) | ルート検索 | 500回/月 | `navitime-route-totalnavi.p.rapidapi.com` |

**重要**: 各サービスは独立しており、合計で月間1,500リクエストまで無料で利用可能。

### 2.2 API詳細仕様

#### 2.2.1 駅検索API（NAVITIME Transport）

**エンドポイント**: `/transport_node/autocomplete`

**リクエスト例**:
```
GET https://navitime-transport.p.rapidapi.com/transport_node/autocomplete
?word=中書島
&word_match=prefix
&datum=wgs84
&coord_unit=degree
```

**ヘッダー**:
```
X-RapidAPI-Key: {YOUR_API_KEY}
X-RapidAPI-Host: navitime-transport.p.rapidapi.com
```

**レスポンス例**:
```json
{
  "items": [
    {
      "id": "00006668",
      "name": "東京",
      "ruby": "とうきょう",
      "types": ["station"],
      "address_name": "東京都千代田区丸の内",
      "coord": {
        "lat": 35.680805,
        "lon": 139.767798
      }
    }
  ]
}
```

**取得できる情報**:
- `id`: 駅ID（node_id）- ルート検索で使用可能
- `name`: 駅名
- `coord`: 緯度経度

---

#### 2.2.2 スポット検索API（NAVITIME Spot）

**エンドポイント**: `/spot`

**リクエスト例**:
```
GET https://navitime-spot.p.rapidapi.com/spot
?word=清風高校
&limit=10
&datum=wgs84
&coord_unit=degree
```

**ヘッダー**:
```
X-RapidAPI-Key: {YOUR_API_KEY}
X-RapidAPI-Host: navitime-spot.p.rapidapi.com
```

**レスポンス例**:
```json
{
  "count": {
    "total": 5,
    "offset": 0,
    "limit": 10
  },
  "items": [
    {
      "code": "02108-XXXX",
      "name": "清風高等学校",
      "phone": "06-XXXX-XXXX",
      "address_name": "大阪府大阪市天王寺区...",
      "coord": {
        "lat": 34.XXXXXX,
        "lon": 135.XXXXXX
      },
      "categories": [
        {
          "code": "XXXXXXXX",
          "name": "高校",
          "level": "detail"
        }
      ]
    }
  ]
}
```

**取得できる情報**:
- `code`: スポットコード
- `name`: スポット名
- `coord`: 緯度経度
- `address_name`: 住所
- `categories`: カテゴリ情報

**注意**: 学校名は完全一致ではなく部分一致検索。同名の学校が複数ヒットする可能性あり。

---

#### 2.2.3 ルート検索API（NAVITIME Route totalnavi）

**エンドポイント**: `/route_transit`

**リクエスト例**:
```
GET https://navitime-route-totalnavi.p.rapidapi.com/route_transit
?start=00006668
&goal=34.702485,135.495951
&start_time=2024-12-19T09:00:00
```

**パラメータ指定方法**:

| パラメータ | 指定方法 | 例 |
|-----------|---------|-----|
| start/goal | 駅ID（node_id） | `00006668` |
| start/goal | 緯度経度 | `35.680805,139.767798` |
| start/goal | JSONオブジェクト | `{"lat":35.68,"lon":139.76,"name":"東京駅"}` |

**ヘッダー**:
```
X-RapidAPI-Key: {YOUR_API_KEY}
X-RapidAPI-Host: navitime-route-totalnavi.p.rapidapi.com
```

**レスポンス（主要部分）**:
```json
{
  "items": [
    {
      "summary": {
        "move": {
          "time": 45,
          "distance": 32500,
          "fare": {
            "unit_0": 890
          },
          "transit_count": 2
        }
      },
      "sections": [...]
    }
  ],
  "unit": {
    "time": "minute",
    "distance": "metre",
    "currency": "JPY"
  }
}
```

**取得できる情報**:
- `time`: 所要時間（分）
- `distance`: 距離（メートル）
- `fare.unit_0`: IC運賃（円）
- `transit_count`: 乗換回数

---

## 3. システム構成

### 3.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                       ユーザー（ブラウザ）                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Next.js (Vercel)                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  フロントエンド (React)                              │   │
│  │  - 駅名入力フォーム（オートコンプリート）             │   │
│  │  - 学校名入力フォーム                                │   │
│  │  - 検索結果表示                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  API Routes (/api/*)                                │   │
│  │  - /api/stations     駅検索プロキシ                  │   │
│  │  - /api/schools      学校検索プロキシ                │   │
│  │  - /api/route        ルート検索プロキシ              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   NAVITIME RapidAPI                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │  Transport  │ │    Spot     │ │  Route(totalnavi)   │   │
│  │  (駅検索)   │ │ (学校検索)  │ │   (ルート検索)      │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js 14 (App Router) |
| 言語 | TypeScript |
| UI | React + Tailwind CSS |
| デプロイ | Vercel |
| API | NAVITIME RapidAPI |
| 状態管理 | React useState |

---

## 4. 画面設計

### 4.1 メイン画面

```
┌─────────────────────────────────────────────────────────────┐
│  🚃 進路指導訪問 所要時間検索                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  出発駅                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 中書島                                          [×] │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ✓ 中書島駅 (京阪本線)                               │   │
│  │   中書島駅 (近鉄京都線)                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  訪問先学校                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 清風高校                                        [×] │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ✓ 清風高等学校 (大阪市天王寺区)                      │   │
│  │   清風南海高等学校 (高石市)                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│           ┌─────────────────────┐                          │
│           │      検索する       │                          │
│           └─────────────────────┘                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  検索結果                                                   │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📍 中書島駅 → 清風高等学校                                 │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🕐 所要時間    約 45 分                             │   │
│  │  📏 距離        32.5 km                              │   │
│  │  🔄 乗換回数    2 回                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [Google Mapsで詳細を見る →]                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 UI/UX仕様

| 項目 | 仕様 |
|------|------|
| 駅名入力 | オートコンプリート（2文字以上で候補表示） |
| 学校名入力 | オートコンプリート（2文字以上で候補表示） |
| 候補選択 | クリックで選択、選択後は候補非表示 |
| 検索ボタン | 両方選択済みの場合のみ有効化 |
| ローディング | 検索中はスピナー表示 |
| エラー表示 | 赤色のアラートで表示 |

---

## 5. 処理フロー

### 5.1 駅名オートコンプリート

```
[ユーザー入力] → [2文字以上?]
                     │
                     ▼ Yes
            [API: /api/stations]
                     │
                     ▼
        [NAVITIME Transport API呼び出し]
                     │
                     ▼
            [候補リスト表示]
                     │
                     ▼
        [ユーザーが候補を選択]
                     │
                     ▼
        [駅情報を状態に保存]
        - id (node_id)
        - name
        - coord (lat, lon)
```

### 5.2 学校名オートコンプリート

```
[ユーザー入力] → [2文字以上?]
                     │
                     ▼ Yes
            [API: /api/schools]
                     │
                     ▼
         [NAVITIME Spot API呼び出し]
                     │
                     ▼
            [候補リスト表示]
            (学校名 + 住所で表示)
                     │
                     ▼
        [ユーザーが候補を選択]
                     │
                     ▼
        [学校情報を状態に保存]
        - code
        - name
        - coord (lat, lon)
        - address_name
```

### 5.3 ルート検索

```
[検索ボタンクリック]
        │
        ▼
[駅・学校 両方選択済み?]
        │
        ▼ Yes
[API: /api/route]
  - start: 駅のnode_id
  - goal: 学校の緯度経度
  - start_time: 現在時刻
        │
        ▼
[NAVITIME Route API呼び出し]
        │
        ▼
[レスポンスから抽出]
  - time (所要時間)
  - distance (距離)
  - transit_count (乗換回数)
        │
        ▼
[結果を表示]
```

---

## 6. API設計

### 6.1 内部API（Next.js API Routes）

#### GET /api/stations

駅名オートコンプリート用

**リクエスト**:
```
GET /api/stations?word=中書島
```

**レスポンス**:
```json
{
  "items": [
    {
      "id": "00XXXXXX",
      "name": "中書島",
      "coord": { "lat": 34.XXX, "lon": 135.XXX }
    }
  ]
}
```

---

#### GET /api/schools

学校検索用

**リクエスト**:
```
GET /api/schools?word=清風高校
```

**レスポンス**:
```json
{
  "items": [
    {
      "code": "XXXXXXXX",
      "name": "清風高等学校",
      "address": "大阪府大阪市天王寺区...",
      "coord": { "lat": 34.XXX, "lon": 135.XXX }
    }
  ]
}
```

---

#### GET /api/route

ルート検索用

**リクエスト**:
```
GET /api/route?start=00XXXXXX&goalLat=34.XXX&goalLon=135.XXX
```

**レスポンス**:
```json
{
  "time": 45,
  "distance": 32500,
  "transitCount": 2
}
```

---

## 7. API消費量見積もり

### 7.1 1回の検索で消費するAPI

| 操作 | API | 消費回数 |
|------|-----|---------|
| 駅名入力（オートコンプリート）| Transport | 1〜3回 |
| 学校名入力（オートコンプリート）| Spot | 1〜3回 |
| ルート検索 | Route | 1回 |

**1回の完全な検索**: 約3〜7リクエスト

### 7.2 月間見積もり

| シナリオ | 計算 | 合計 |
|----------|------|------|
| 教員5人 × 20校 × 月1回 | 5 × 20 × 5 = 500 | 500回 |
| テスト・デバッグ | - | 100回 |
| **合計** | | **600回** |

各サービス500回/月の制限があるため、**十分に収まる見込み**。

ただし、オートコンプリートの呼び出し回数を減らす工夫が必要：
- デバウンス処理（300ms）
- 最小入力文字数（2文字）

---

## 8. ディレクトリ構成

```
school-visit-app/
├── app/
│   ├── page.tsx              # メインページ
│   ├── layout.tsx            # レイアウト
│   ├── globals.css           # グローバルスタイル
│   └── api/
│       ├── stations/
│       │   └── route.ts      # 駅検索API
│       ├── schools/
│       │   └── route.ts      # 学校検索API
│       └── route/
│           └── route.ts      # ルート検索API
├── components/
│   ├── StationInput.tsx      # 駅入力コンポーネント
│   ├── SchoolInput.tsx       # 学校入力コンポーネント
│   └── ResultCard.tsx        # 結果表示コンポーネント
├── lib/
│   └── navitime.ts           # NAVITIME API呼び出し関数
├── types/
│   └── index.ts              # 型定義
├── .env.local                # 環境変数（APIキー）
├── package.json
├── tsconfig.json
└── tailwind.config.js
```

---

## 9. 環境変数

```env
# .env.local
RAPIDAPI_KEY=your_rapidapi_key_here
```

**注意**: Vercelデプロイ時は環境変数をVercelダッシュボードで設定すること。

---

## 10. 実装上の注意点

### 10.1 APIキーの保護
- クライアントサイドから直接NAVITIME APIを呼び出さない
- Next.js API Routesを経由してサーバーサイドで呼び出す
- 環境変数は`.env.local`に保存し、Gitにコミットしない

### 10.2 デバウンス処理
オートコンプリートでAPI呼び出しを抑制：
```typescript
// 300ms待ってから検索実行
const debouncedSearch = useMemo(
  () => debounce((word: string) => searchStations(word), 300),
  []
);
```

### 10.3 エラーハンドリング
- API制限超過時のエラーメッセージ
- ネットワークエラー時のリトライ
- 候補が見つからない場合の表示

### 10.4 NAVITIME API利用規約
以下は禁止事項（今回の用途では問題なし）：
- カーナビ連携
- 動態管理サービス
- 音声ナビゲーション
- データのキャッシュ保存

---

## 11. 今後の拡張案

1. **学校リストの事前登録**: よく訪問する学校をリスト化
2. **教員ごとの最寄り駅保存**: Supabaseでユーザー管理
3. **複数ルート比較**: 複数の経路候補を表示
4. **運賃表示**: 交通費精算用に運賃も表示
5. **履歴機能**: 過去の検索履歴を保存

---

## 12. 開発スケジュール（参考）

| フェーズ | 内容 | 工数目安 |
|---------|------|---------|
| 1 | プロジェクト初期化・環境構築 | 0.5日 |
| 2 | API Routes実装 | 1日 |
| 3 | フロントエンド実装 | 1日 |
| 4 | テスト・デバッグ | 0.5日 |
| 5 | Vercelデプロイ | 0.5日 |
| **合計** | | **3.5日** |

---

## 付録: RapidAPI登録手順

1. https://rapidapi.com/ にアクセス
2. アカウント作成（Google連携可）
3. 以下のサービスをそれぞれSubscribe（BASICプラン/無料）:
   - NAVITIME Transport
   - NAVITIME Spot
   - NAVITIME Route(totalnavi)
4. APIキーを取得（各サービス共通のキー）
5. `.env.local`に設定

---

**作成日**: 2024年12月19日  
**作成者**: Claude
